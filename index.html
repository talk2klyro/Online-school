<!--
  Index-upgraded-dashboard.html
  Upgraded Dashboard (index.html) for School Admin SaaS
  - Modern, accessible, responsive dashboard matching Attendance-upgraded styles/tone
  - Uses Tailwind (Play CDN for prototype). Replace with compiled Tailwind in production.
  - Lazy-loads Chart.js, Ably, Magic SDK only when needed
  - No secrets in client. Use import.meta.env or window.APP_CONFIG for runtime values.

  Important: implement server endpoints described in SCRIPT comments. Rotate any keys previously exposed.
  (Generated by GPT-5 Thinking mini.)
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard ‚Ä¢ School Admin SaaS</title>
  <meta name="description" content="Admin dashboard: attendance, students, quick actions" />

  <!-- Tailwind Play CDN for prototype. Use compiled Tailwind in production -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/style.css" />

  <style>
    .card { background: white; border: 1px solid rgba(15,23,42,0.04); border-radius: 12px; }
    .sparkline { height: 36px; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
  <header class="bg-white/80 backdrop-blur sticky top-0 z-30 border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="text-2xl">üè´</div>
        <div>
          <div class="font-semibold text-lg">School Admin SaaS</div>
          <div class="text-xs text-slate-500">Dashboard</div>
        </div>
      </div>
      <nav class="flex items-center gap-3">
        <a class="text-sm text-slate-600 hover:text-slate-900" href="/students.html">Students</a>
        <a class="text-sm text-slate-600 hover:text-slate-900" href="/attendance.html">Attendance</a>
        <a class="text-sm text-slate-600 hover:text-slate-900" href="/reports.html">Reports</a>
        <a class="text-sm text-slate-600 hover:text-slate-900" href="/export.html">Export</a>
        <button id="logoutBtn" class="ml-3 px-3 py-1 rounded-md border">Logout</button>
      </nav>
    </div>
  </header>

  <main class="max-w-7xl mx-auto p-4 grid grid-cols-1 gap-6">

    <!-- Top cards -->
    <section class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div class="card p-4 shadow-sm flex flex-col gap-2">
        <div class="text-xs text-slate-500">Total Students</div>
        <div class="text-2xl font-semibold" id="totalStudents">‚Äî</div>
        <div class="text-xs text-slate-400">Updated just now</div>
      </div>

      <div class="card p-4 shadow-sm flex flex-col gap-2">
        <div class="text-xs text-slate-500">Today's Attendance</div>
        <div class="text-2xl font-semibold" id="todayAttendance">‚Äî</div>
        <div class="flex items-center gap-3">
          <canvas id="todaySpark" class="sparkline" width="120" height="36"></canvas>
          <div class="text-xs text-slate-400">Week overview</div>
        </div>
      </div>

      <div class="card p-4 shadow-sm flex flex-col gap-2">
        <div class="text-xs text-slate-500">Active Classes</div>
        <div class="text-2xl font-semibold" id="activeClasses">‚Äî</div>
        <div class="text-xs text-slate-400">Click to manage classes</div>
      </div>

      <div class="card p-4 shadow-sm flex flex-col gap-2">
        <div class="text-xs text-slate-500">New Students (7d)</div>
        <div class="text-2xl font-semibold" id="newStudents7d">‚Äî</div>
        <div class="text-xs text-slate-400">Growth rate</div>
      </div>
    </section>

    <!-- Main content grid -->
    <section class="grid grid-cols-1 lg:grid-cols-3 gap-4">

      <!-- Left: charts -->
      <div class="lg:col-span-2 grid grid-cols-1 gap-4">
        <div class="card p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Attendance ‚Äî Last 30 days</h3>
            <div class="text-xs text-slate-500">Auto-updates via realtime</div>
          </div>
          <div class="mt-3">
            <canvas id="attendance30Chart" height="220" aria-label="Attendance last 30 days"></canvas>
          </div>
        </div>

        <div class="card p-4 shadow-sm">
          <div class="flex items-center justify-between">
            <h3 class="font-semibold">Student Growth</h3>
            <div class="text-xs text-slate-500">Monthly</div>
          </div>
          <div class="mt-3">
            <canvas id="studentGrowthChart" height="180" aria-label="Student growth chart"></canvas>
          </div>
        </div>
      </div>

      <!-- Right: activity + shortcuts -->
      <aside class="card p-4 shadow-sm">
        <div class="flex items-center justify-between">
          <h3 class="font-semibold">Recent Activity</h3>
          <button id="viewAllActivity" class="text-xs text-indigo-600">View all</button>
        </div>
        <ul id="activityList" class="mt-3 space-y-2 text-sm text-slate-700">
          <!-- Populated by JS -->
        </ul>

        <hr class="my-3" />
        <div class="space-y-2">
          <button id="quickAdd" class="w-full p-2 bg-indigo-600 text-white rounded">Add Student</button>
          <button id="quickAttendance" class="w-full p-2 border rounded">Mark Attendance</button>
          <button id="quickReport" class="w-full p-2 border rounded">Generate Report</button>
        </div>
      </aside>

    </section>

    <section class="card p-4 shadow-sm">
      <h3 class="font-semibold">System Notes & Actions</h3>
      <div class="text-xs text-slate-500 mt-2">Below are recommended operational items and quick links for developers/admins.</div>
      <ul class="mt-2 text-sm text-slate-700 space-y-1">
        <li>Rotate provider keys if exposed.</li>
        <li>Implement server endpoints: <code>/api/summary</code>, <code>/api/recent-activity</code>, <code>/api/classes</code>, <code>/api/metrics</code>.</li>
        <li>Use Ably token endpoint at <code>/api/ably/token</code> for realtime auth (no client secrets).</li>
      </ul>
    </section>

  </main>

  <footer class="max-w-7xl mx-auto p-4 text-center text-xs text-slate-500">&copy; 2025 School Admin SaaS ‚Ä¢ v1.0</footer>

  <!-- Client logic: module -->
  <script type="module">
  // CONFIG: use import.meta.env in a bundler or set window.APP_CONFIG before loading in non-bundler setups
  const CONFIG = {
    API_BASE: import.meta?.env?.VITE_API_BASE || window.APP_CONFIG?.API_BASE || '',
    MAGIC_PUBLISHABLE: import.meta?.env?.VITE_MAGIC_PUBLISHABLE || window.APP_CONFIG?.MAGIC_PUBLISHABLE || '__MAGIC__',
    ABLY_AUTH_URL: '/api/ably/token'
  };

  // Helpers
  const $ = (s, r=document)=> r.querySelector(s);
  const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));
  function loadScript(src){ return new Promise((res,rej)=>{ const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>res(); s.onerror=e=>rej(e); document.head.appendChild(s); }); }

  async function apiGET(path){ const res = await fetch((CONFIG.API_BASE||'')+path, {credentials:'include'}); if(!res.ok) throw new Error('API fail '+res.status); return res.json(); }

  // Lazy initializers
  let chartInstances = [];
  function destroyCharts(){ chartInstances.forEach(c=>{ try{ c.destroy(); }catch(e){} }); chartInstances=[]; }

  async function ensureChart(){ if(typeof Chart === 'undefined') await loadScript('https://cdn.jsdelivr.net/npm/chart.js'); }

  // Dashboard rendering
  async function renderSummary(){
    try{
      const summary = await apiGET('/api/summary');
      $('#totalStudents').textContent = summary.totalStudents ?? '0';
      $('#todayAttendance').textContent = (summary.todayAttendancePct ?? 0) + '%';
      $('#activeClasses').textContent = summary.activeClasses ?? '0';
      $('#newStudents7d').textContent = summary.newStudents7d ?? '0';

      // Sparkline for week overview
      const spark = document.getElementById('todaySpark').getContext('2d');
      await ensureChart(); destroyCharts();
      const sparkChart = new Chart(spark, { type:'line', data:{ labels: summary.weekLabels || [], datasets:[{ data: summary.weekAttendance || [], fill:true, tension:0.3, borderColor:'#4F46E5', backgroundColor:'rgba(79,70,229,0.12)' }] }, options:{ responsive:false, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}} } });
      chartInstances.push(sparkChart);

      // Main charts
      await renderMainCharts(summary.attendanceLast30, summary.studentGrowthMonthly);
    }catch(e){ console.error('renderSummary', e); }
  }

  async function renderMainCharts(attendanceLast30=[], growthMonthly=[]){
    await ensureChart();
    destroyCharts();
    const ctx = document.getElementById('attendance30Chart').getContext('2d');
    const c1 = new Chart(ctx, { type:'line', data:{ labels: attendanceLast30.map(d=>d.label), datasets:[{ label:'Present', data: attendanceLast30.map(d=>d.value), borderColor:'#10B981', backgroundColor:'rgba(16,185,129,0.08)', fill:true }] }, options:{ responsive:true } });
    chartInstances.push(c1);

    const ctx2 = document.getElementById('studentGrowthChart').getContext('2d');
    const c2 = new Chart(ctx2, { type:'bar', data:{ labels: growthMonthly.map(d=>d.label), datasets:[{ label:'Students', data: growthMonthly.map(d=>d.value), backgroundColor:'#4F46E5' }] }, options:{ responsive:true } });
    chartInstances.push(c2);
  }

  // Recent activity
  async function loadActivity(){
    try{
      const recent = await apiGET('/api/recent-activity');
      const ul = $('#activityList'); ul.innerHTML='';
      recent.slice(0,6).forEach(item=>{
        const li = document.createElement('li'); li.className='flex items-start gap-3';
        li.innerHTML = `<div class="w-8 h-8 rounded bg-slate-100 flex items-center justify-center text-xs">${item.type[0]||'A'}</div><div><div class="text-sm font-medium">${escapeHtml(item.title)}</div><div class="text-xs text-slate-500">${escapeHtml(item.subtitle)} ‚Ä¢ ${new Date(item.ts).toLocaleString()}</div></div>`;
        ul.appendChild(li);
      });
    }catch(e){ console.error('loadActivity', e); }
  }

  // Escape HTML
  function escapeHtml(s){ return s ? s.replace(/[&<"'`=\/]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"\/","`":"&#96;"})[c]) : ''; }

  // Realtime: Ably token auth (server must implement /api/ably/token)
  let ablyRealtime = null;
  async function initRealtime(){
    if(typeof Ably === 'undefined') await loadScript('https://cdn.ably.io/lib/ably.min-1.js');
    try{
      ablyRealtime = new Ably.Realtime({ authUrl: CONFIG.ABLY_AUTH_URL });
      const ch = ablyRealtime.channels.get('dashboard-updates');
      ch.subscribe('summary:update', async (msg) => {
        // payload can include partial update; refresh summary or patch DOM
        await renderSummary(); await loadActivity();
      });
    }catch(e){ console.warn('Ably realtime init failed', e); }
  }

  // UI wiring
  $('#quickAdd').addEventListener('click', ()=> location.href='/add-student.html');
  $('#quickAttendance').addEventListener('click', ()=> location.href='/attendance.html');
  $('#quickReport').addEventListener('click', ()=> location.href='/reports.html');
  $('#viewAllActivity').addEventListener('click', ()=> location.href='/activity.html');

  $('#logoutBtn').addEventListener('click', async ()=>{ try{ if(window.Magic){ await window.Magic.logout?.(); } await fetch('/api/logout',{method:'POST',credentials:'include'}); location.reload(); }catch(e){ location.reload(); } });

  // Init
  (async function init(){
    try{
      // Optionally initialize Magic client to check login state (publishable key only)
      if(typeof window.Magic === 'undefined') await loadScript('https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js');
      // Note: server-side verification required before allowing writes.

      await renderSummary(); await loadActivity(); await initRealtime();
      // Periodic refresh
      setInterval(()=>{ renderSummary().catch(()=>{}); loadActivity().catch(()=>{}); }, 60_000);
    }catch(e){ console.error('dashboard init', e); }
  })();

  // Server integration notes (implement on server):
  /*
    GET /api/summary
      Response: { totalStudents, todayAttendancePct, activeClasses, newStudents7d, weekLabels:[], weekAttendance:[], attendanceLast30:[{label,value}], studentGrowthMonthly:[{label,value}] }

    GET /api/recent-activity
      Response: [{ type, title, subtitle, ts }]

    POST /api/ably/token
      - returns Ably tokenRequest created with Ably.Rest on server

    Security:
      - Place provider secrets (Ably, Cloudinary, Neon, Magic secret) in server .env
      - Validate session tokens server-side (Magic or other) prior to returning sensitive data
      - Add CSP headers, secure cookies, and rate limiting
  */

  </script>
</body>
</html>
