<!--
  attendance-upgraded.html
  Industry-standard, production-ready attendance panel for School Admin SaaS

  Key features:
  - Tailwind-based, responsive, accessible UI (use Tailwind via CDN for prototype, move to compiled Tailwind in prod)
  - Secure-by-design: no secrets in client; uses server endpoints for Ably token & API
  - Realtime via Ably (authUrl token flow) ‚Äî client never sees Ably secret
  - Magic (publishable key) used client-side; server must verify DID tokens for secure sessions
  - Optimistic updates with offline queue + automatic sync when back online
  - Export CSV + PDF (lazy-loads jsPDF + html2canvas)
  - Keyboard & screen-reader accessible controls, aria-live feedback
  - Bulk actions (mark week present/absent) + search/filter
  - Clear integration instructions and server endpoints commented inside

  Important: rotate any keys that were previously exposed and implement server endpoints described in comments.
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attendance ‚Ä¢ School Admin SaaS</title>
  <meta name="description" content="Attendance register ‚Äî realtime, exportable, offline-friendly" />

  <!-- Prototype Tailwind (Play CDN). Replace with compiled Tailwind in production -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/styles.css" />

  <!-- Small visually-hidden helper for accessibility -->
  <style>
    .visually-hidden { position: absolute !important; height: 1px; width: 1px; overflow: hidden; clip: rect(1px, 1px, 1px, 1px); white-space: nowrap; }
    /* table horizontal scroll on narrow screens */
    .table-scroll { overflow:auto; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800 antialiased">
  <header class="bg-white/80 backdrop-blur sticky top-0 z-30 border-b">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="text-2xl">üè´</div>
        <div>
          <div class="font-semibold text-lg">School Admin SaaS</div>
          <div class="text-xs text-slate-500">Attendance ‚Ä¢ Realtime ‚Ä¢ Exportable</div>
        </div>
      </div>
      <nav class="flex items-center gap-3">
        <a class="text-sm text-slate-600 hover:text-slate-900" href="/index.html">Dashboard</a>
        <a class="text-sm text-slate-600 hover:text-slate-900" href="/add-student.html">Add Student</a>
        <a class="text-sm text-indigo-600 font-medium" href="/attendance.html">Attendance</a>
        <button id="logoutBtn" class="ml-3 px-3 py-1 rounded-md border">Logout</button>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Controls -->
    <section class="lg:col-span-3 bg-white p-4 rounded-xl shadow-sm">
      <h3 class="text-md font-semibold">Controls</h3>
      <div class="mt-3 space-y-3">
        <label class="block text-sm font-medium">Class</label>
        <select id="select-class" class="w-full p-2 border rounded" aria-label="Select class"></select>

        <label class="block text-sm font-medium">Week</label>
        <select id="select-week" class="w-full p-2 border rounded" aria-label="Select week">
          <!-- Weeks 1..12 generated by JS -->
        </select>

        <div class="flex gap-2">
          <button id="bulk-present" class="flex-1 bg-indigo-600 text-white p-2 rounded">Mark Present</button>
          <button id="bulk-absent" class="flex-1 bg-white border p-2 rounded">Mark Absent</button>
        </div>

        <div class="flex gap-2">
          <button id="export-csv" class="w-1/2 p-2 border rounded">Export CSV</button>
          <button id="export-pdf" class="w-1/2 p-2 border rounded">Export PDF</button>
        </div>

        <input id="search" class="w-full p-2 border rounded" placeholder="Search student name or phone" aria-label="Search students" />

        <div class="text-sm text-slate-500">Status: <span id="statusMsg" class="font-medium">Idle</span></div>
        <div id="liveRegion" class="visually-hidden" aria-live="polite"></div>
      </div>

      <hr class="my-3" />
      <div class="text-xs text-slate-500">Tips: Use keyboard to navigate the table. Offline changes are queued and auto-synced when online.</div>
    </section>

    <!-- Attendance table -->
    <section class="lg:col-span-6 bg-white p-4 rounded-xl shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">Attendance Register</h2>
        <div class="text-sm text-slate-500">Selectable rows ‚Äî click to toggle</div>
      </div>

      <div class="mt-3 table-scroll">
        <table id="attTable" class="min-w-full text-sm">
          <thead class="bg-slate-100 sticky top-0">
            <tr>
              <th class="p-2 text-left">#</th>
              <th class="p-2 text-left">Name</th>
              <th class="p-2 text-left">Phone</th>
              <!-- Weeks 1-12 header -->
              <th class="p-2 text-center" colspan="12">Weeks</th>
            </tr>
            <tr id="weeksHeader" class="bg-white"> <!-- generated by JS --></tr>
          </thead>
          <tbody id="attBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Analytics & details -->
    <aside class="lg:col-span-3 bg-white p-4 rounded-xl shadow-sm">
      <h3 class="text-md font-semibold">Analytics</h3>
      <div class="mt-3">
        <canvas id="attendanceTrendChart" width="400" height="220" aria-label="Attendance trend chart"></canvas>
      </div>

      <div class="mt-4">
        <h4 class="font-medium">Quick Actions</h4>
        <button id="syncQueue" class="mt-2 w-full p-2 border rounded">Sync Now</button>
        <div id="queueCount" class="text-sm text-slate-500 mt-1">Queue: 0</div>
      </div>
    </aside>

  </main>

  <footer class="max-w-6xl mx-auto p-4 text-center text-xs text-slate-500">&copy; 2025 School Admin SaaS</footer>

  <!-- Scripts -->
  <script type="module">
  // CONFIG (in prod inject via bundler or set window.APP_CONFIG before loading this file)
  const CONFIG = {
    API_BASE: import.meta?.env?.VITE_API_BASE || window.APP_CONFIG?.API_BASE || '',
    MAGIC_PUBLISHABLE: import.meta?.env?.VITE_MAGIC_PUBLISHABLE || window.APP_CONFIG?.MAGIC_PUBLISHABLE || '__MAGIC_PUBLISHABLE__',
    ABLY_AUTH_URL: '/api/ably/token', // server endpoint that returns Ably tokenRequest
    API_HEADERS: { 'Content-Type': 'application/json' }
  };

  // Utility: lazy load external scripts
  function loadScript(src){
    return new Promise((resolve,reject)=>{
      const s=document.createElement('script'); s.src=src; s.async=true; s.onload=()=>resolve(); s.onerror=(e)=>reject(e); document.head.appendChild(s);
    });
  }

  // Small helper for DOM selection
  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // Offline queue persisted in localStorage (simple, replace with IndexedDB for large scale)
  const QUEUE_KEY = 'attendanceQueue_v1';
  function readQueue(){ try{ return JSON.parse(localStorage.getItem(QUEUE_KEY) || '[]'); }catch(e){ return []; } }
  function writeQueue(q){ localStorage.setItem(QUEUE_KEY, JSON.stringify(q)); updateQueueCount(); }
  function pushQueue(item){ const q=readQueue(); q.push(item); writeQueue(q); }
  function shiftQueue(){ const q=readQueue(); const it=q.shift(); writeQueue(q); return it; }
  function updateQueueCount(){ const n = readQueue().length; $('#queueCount').textContent = `Queue: ${n}`; }

  // Status helpers
  function setStatus(text){ $('#statusMsg').textContent = text; $('#liveRegion').textContent = text; }

  // Initialize Magic (client-side publishable only)
  let magic = null;
  async function initMagic(){
    if(window.Magic === undefined) await loadScript('https://cdn.jsdelivr.net/npm/magic-sdk/dist/magic.js');
    try{ magic = new window.Magic(CONFIG.MAGIC_PUBLISHABLE); }
    catch(e){ console.warn('Magic init failed', e); }
  }

  // Ably realtime (authUrl) ‚Äî client only uses token endpoint
  let ablyRealtime = null;
  async function initAbly(){
    if(window.Ably === undefined) await loadScript('https://cdn.ably.io/lib/ably.min-1.js');
    try{
      ablyRealtime = new Ably.Realtime({ authUrl: CONFIG.ABLY_AUTH_URL });
      ablyRealtime.connection.on('connected', ()=>console.log('Ably connected'));
    }catch(e){ console.warn('Ably init failed', e); }
  }

  // API helper
  async function apiGET(path){
    const res = await fetch((CONFIG.API_BASE || '') + path, { credentials: 'include' });
    if(!res.ok) throw new Error(`GET ${path} failed ${res.status}`);
    return res.json();
  }
  async function apiPOST(path, body){
    const res = await fetch((CONFIG.API_BASE || '') + path, { method:'POST', credentials:'include', headers: CONFIG.API_HEADERS, body: JSON.stringify(body) });
    if(!res.ok) throw new Error(`POST ${path} failed ${res.status}`);
    return res.json();
  }
  async function apiPUT(path, body){
    const res = await fetch((CONFIG.API_BASE || '') + path, { method:'PUT', credentials:'include', headers: CONFIG.API_HEADERS, body: JSON.stringify(body) });
    if(!res.ok) throw new Error(`PUT ${path} failed ${res.status}`);
    return res.json();
  }

  // Render weeks header (1..12)
  function renderWeeksHeader(){
    const header = $('#weeksHeader'); header.innerHTML = '<th></th><th></th><th></th>'; // keep SN/Name/Phone columns
    for(let w=1; w<=12; w++){
      const th = document.createElement('th'); th.className='p-2 text-center'; th.textContent = `W${w}`; header.appendChild(th);
    }
  }

  // Render students table
  function renderStudents(students, weekFilter=null){
    const tbody = $('#attBody'); tbody.innerHTML = '';
    students.forEach((s, idx) => {
      const tr = document.createElement('tr'); tr.className='border-b'; tr.dataset.id = s.id;
      const snTd = `<td class="p-2">${s.sn || idx+1}</td>`;
      const nameTd = `<td class="p-2">${escapeHtml(s.name)}</td>`;
      const phoneTd = `<td class="p-2">${escapeHtml(s.phone||'')}</td>`;

      let weeksHtml = '';
      for(let w=1; w<=12; w++){
        const checked = s[`week${w}`] ? 'checked' : '';
        const disabled = '';
        weeksHtml += `<td class="p-2 text-center"><input type="checkbox" class="week-checkbox" data-week="week${w}" data-id="${s.id}" ${checked} ${disabled} aria-label="${s.name} week ${w} present"></td>`;
      }
      tr.innerHTML = snTd + nameTd + phoneTd + weeksHtml;
      tbody.appendChild(tr);
    });
  }

  // Escape HTML to avoid XSS when injecting text
  function escapeHtml(unsafe){ return unsafe ? unsafe.replace(/[&<"'`=\/]/g, function(s){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;","/":"\/","=`":"&#96;"})[s]; }) : '' }

  // Load classes and init UI
  let ALL_STUDENTS = [];
  async function loadClasses(){
    setStatus('Loading classes...');
    try{
      const classes = await apiGET('/api/classes');
      const sel = $('#select-class'); sel.innerHTML = '';
      classes.forEach(c => { const opt=document.createElement('option'); opt.value=c.id; opt.textContent=c.name; sel.appendChild(opt); });
      // weeks select
      const weekSel = $('#select-week'); weekSel.innerHTML=''; for(let w=1; w<=12; w++){ const o=document.createElement('option'); o.value=w; o.textContent=`Week ${w}`; weekSel.appendChild(o);} 
      setStatus('Classes loaded');
      if(classes.length){ await loadAttendanceForClass(classes[0].id); }
    }catch(e){ console.error(e); setStatus('Failed to load classes'); }
  }

  // Load attendance for class
  async function loadAttendanceForClass(classId){
    setStatus('Loading students...');
    try{
      const students = await apiGET(`/api/students?classId=${encodeURIComponent(classId)}`);
      ALL_STUDENTS = students;
      renderStudents(students);
      updateChart(students);
      setStatus('Ready');
    }catch(e){ console.error(e); setStatus('Failed to load students'); }
  }

  // Event delegation for toggling attendance
  document.addEventListener('change', async (ev)=>{
    if(ev.target.matches('.week-checkbox')){
      const id = ev.target.dataset.id; const week = ev.target.dataset.week; const present = ev.target.checked; const classId = $('#select-class').value;
      // optimistic: update local array
      const s = ALL_STUDENTS.find(x=>x.id==id); if(s) s[week]=present;
      updateChart(ALL_STUDENTS);
      // push to queue and try to sync
      const op = { type:'update', id, week, present, classId, ts: Date.now() };
      pushQueue(op); setStatus('Queued change');
      try{ await processQueue(); }catch(err){ console.warn('Process queue failed', err); }
    }
  });

  // Bulk actions
  $('#bulk-present').addEventListener('click', ()=>{ performBulk(true); });
  $('#bulk-absent').addEventListener('click', ()=>{ performBulk(false); });

  function performBulk(present){
    const week = $('#select-week').value; const classId = $('#select-class').value;
    if(!week || !classId) return; 
    const inputs = $$('#attBody .week-checkbox[data-week="week'+week+'"]');
    inputs.forEach(inp=>{ inp.checked = present; const id = inp.dataset.id; const op={type:'update', id, week:`week${week}`, present, classId, ts:Date.now()}; pushQueue(op); const s = ALL_STUDENTS.find(x=>x.id==id); if(s) s[`week${week}`]=present; });
    updateChart(ALL_STUDENTS);
    setStatus('Bulk changes queued');
    processQueue().catch(e=>console.warn(e));
  }

  // Search
  $('#search').addEventListener('input', (e)=>{
    const q = e.target.value.trim().toLowerCase(); if(!q){ renderStudents(ALL_STUDENTS); return; }
    const filtered = ALL_STUDENTS.filter(s=> (s.name||'').toLowerCase().includes(q) || (s.phone||'').toLowerCase().includes(q)); renderStudents(filtered);
  });

  // Process offline queue: send to server, publish to Ably
  let processingQueue = false;
  async function processQueue(){
    if(processingQueue) return; processingQueue = true;
    const q = readQueue();
    while(q.length){
      const item = q[0];
      try{
        // send to API
        await apiPUT('/api/attendance', { id: item.id, week: item.week, present: item.present, classId: item.classId });
        // broadcast via Ably (if connected)
        if(ablyRealtime){
          const ch = ablyRealtime.channels.get(`attendance-${item.classId}`);
          ch.publish('update', { id: item.id, week: item.week, present: item.present, ts: Date.now() });
        }
        // remove first item
        q.shift(); writeQueue(q);
        setStatus('Synced');
      }catch(err){
        console.warn('Queue item failed, will retry later', err); setStatus('Sync failed, retrying later'); break; // stop processing and retry later
      }
    }
    processingQueue = false;
  }

  // Manual sync button
  $('#syncQueue').addEventListener('click', ()=>{ processQueue().catch(e=>console.warn(e)); });

  // Online/offline handling
  window.addEventListener('online', ()=>{ setStatus('Back online ‚Äî syncing...'); processQueue(); });
  window.addEventListener('offline', ()=>{ setStatus('Offline ‚Äî changes queued'); });

  // Realtime subscribe: when we join class channel we listen for updates
  function subscribeToClassRealtime(classId){
    if(!ablyRealtime) return; 
    // unsubscribe others
    if(window._subChannel) try{ window._subChannel.unsubscribe(); }catch(e){}
    const channel = ablyRealtime.channels.get(`attendance-${classId}`);
    window._subChannel = channel;
    channel.subscribe('update', msg => {
      const payload = msg.data;
      // update UI only if not from this client (server can embed source if needed)
      const row = document.querySelector(`#attBody tr[data-id='${payload.id}']`);
      if(row){
        const cb = row.querySelector(`.week-checkbox[data-week='${payload.week}']`);
        if(cb){ cb.checked = !!payload.present; const s = ALL_STUDENTS.find(x=>x.id==payload.id); if(s) s[payload.week]=!!payload.present; updateChart(ALL_STUDENTS); }
      }
    });
  }

  // Chart.js attendance trend
  let attendanceChart = null;
  async function updateChart(students){
    // compute weekly totals
    const weeklyTotals = Array.from({length:12}, (_,i)=>0);
    students.forEach(s => { for(let i=0;i<12;i++){ if(s[`week${i+1}`]) weeklyTotals[i]++; } });
    // lazy load Chart.js
    if(typeof Chart === 'undefined') await loadScript('https://cdn.jsdelivr.net/npm/chart.js');
    const ctx = document.getElementById('attendanceTrendChart').getContext('2d');
    if(attendanceChart) attendanceChart.destroy();
    attendanceChart = new Chart(ctx, { type:'line', data: { labels: weeklyTotals.map((_,i)=>`W${i+1}`), datasets: [{ label:'Present', data: weeklyTotals, tension:0.3, fill:true, backgroundColor:'rgba(79,70,229,0.12)', borderColor:'#4F46E5' }] }, options:{ responsive:true } });
  }

  // Export CSV from current table state
  function exportCSV(){
    const classId = $('#select-class').value; if(!classId) return alert('Select a class');
    const rows = [];
    const header = ['SN','Name','Phone', ...Array.from({length:12},(_,i)=>`W${i+1}`)]; rows.push(header.join(','));
    ALL_STUDENTS.forEach((s,idx)=>{
      const row = [s.sn||idx+1, `"${s.name.replace(/"/g,'""')}"`, s.phone||''];
      for(let i=1;i<=12;i++) row.push(s[`week${i}`] ? '1' : '0');
      rows.push(row.join(','));
    });
    const csv = rows.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `attendance-${classId}.csv`; a.click(); URL.revokeObjectURL(url);
    setStatus('CSV exported');
  }

  // Export PDF (uses jsPDF + html2canvas)
  async function exportPDF(){
    setStatus('Preparing PDF...');
    if(typeof window.jspdf === 'undefined'){
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'landscape', unit:'pt', format:'a4' });
    const node = document.querySelector('.table-scroll');
    const canvas = await html2canvas(node, { scale:1.5 });
    const imgData = canvas.toDataURL('image/png');
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const imgProps = doc.getImageProperties(imgData);
    const imgWidth = pageWidth - 80; const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
    doc.setFontSize(14); doc.text('Attendance Report', 40, 40);
    doc.addImage(imgData, 'PNG', 40, 60, imgWidth, imgHeight);
    doc.save(`attendance-${$('#select-class').value}.pdf`);
    setStatus('PDF exported');
  }

  // Wire export buttons
  $('#export-csv').addEventListener('click', exportCSV);
  $('#export-pdf').addEventListener('click', ()=>{ exportPDF().catch(e=>{ console.error(e); setStatus('PDF export failed'); }); });

  // class select change -> reload students & resubscribe
  $('#select-class').addEventListener('change', async (e)=>{ const classId=e.target.value; await loadAttendanceForClass(classId); subscribeToClassRealtime(classId); });

  // Initialize app
  (async function init(){
    renderWeeksHeader(); updateQueueCount();
    await initMagic(); await initAbly();
    await loadClasses();
    // if user is logged-in check (Magic) then verify on server before allowing writes; server must validate DID tokens
    // TODO: call /api/magic/verify in production to validate session
    // start periodic sync
    setInterval(()=>{ if(navigator.onLine) processQueue(); }, 30_000);
  })();

  // Sync queue on unload to try to flush
  window.addEventListener('beforeunload', ()=>{ if(readQueue().length) localStorage.setItem('attendanceQueueBeforeUnload', JSON.stringify(readQueue())); });

  // Helper: basic logout
  $('#logoutBtn').addEventListener('click', async ()=>{
    try{ if(magic) await magic.user.logout(); await fetch('/api/logout', { method:'POST', credentials:'include' }); location.reload(); }catch(e){ location.reload(); }
  });

  // Integration notes (server endpoints required):
  /*
    GET /api/classes
      - returns [{ id, name }]

    GET /api/students?classId=CLASS_ID
      - returns array of students with fields: id, sn, name, phone, week1..week12 (booleans)

    PUT /api/attendance
      - request body: { id, week, present, classId }
      - updates row in Postgres/Neon
      - returns 200 on success

    POST /api/ably/token
      - Ably tokenRequest endpoint (server-side uses Ably.Rest to createTokenRequest)
      - client config uses { authUrl: '/api/ably/token' }

    POST /api/magic/verify (optional but recommended)
      - server verifies DID token via @magic-sdk/admin and returns user metadata

    Security:
      - Store secrets on server .env, never in client
      - Validate sessions on server for write APIs
      - Use prepared statements/parameterized queries for DB operations
      - Add CORS, CSP, secure cookies and rate limiting in production
  */

  </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Register</title>

  <style>
    /* === Minimal Glass / Frosted Minimal Style === */
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', Roboto, system-ui, sans-serif;
      background: linear-gradient(135deg, #f9f9f9, #eaeaea);
      color: #111;
    }

    /* Brand Header */
    .brand {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.4);
    }

    .brand h1 {
      margin: 0;
      font-size: 22px;
      font-weight: 600;
    }

    /* Navigation */
    .nav {
      display: flex;
      gap: 10px;
      padding: 12px 20px;
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    .nav a {
      text-decoration: none;
      padding: 8px 14px;
      border-radius: 12px;
      font-size: 14px;
      background: rgba(255, 255, 255, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(8px);
      color: #111;
      transition: all 0.2s ease;
    }

    .nav a:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Card */
    .card {
      background: rgba(255, 255, 255, 0.35);
      border: 1px solid rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(12px);
      border-radius: 20px;
      padding: 20px;
      margin: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      overflow-x: auto;
    }

    /* Table */
    .table {
      width: 100%;
      border-collapse: collapse;
      min-width: 800px;
    }

    .table th,
    .table td {
      padding: 10px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      font-size: 13px;
      text-align: center;
    }

    .table th {
      background: rgba(255, 255, 255, 0.4);
      backdrop-filter: blur(6px);
      font-weight: 500;
    }

    /* Footer */
    footer {
      padding: 24px;
      text-align: center;
      font-size: 13px;
      color: #555;
      background: rgba(255, 255, 255, 0.3);
      backdrop-filter: blur(6px);
      margin-top: 30px;
      border-top: 1px solid rgba(255, 255, 255, 0.3);
    }
  </style>
</head>

<body>
  <!-- Header -->
  <div class="brand">
    <h1>Attendance Register</h1>
  </div>

  <!-- Navigation -->
  <div class="nav">
    <a href="index.html">Dashboard</a>
    <a href="add-student.html">Add Student</a>
    <a href="attendance.html">Attendance</a>
    <a href="export.html">Export</a>
  </div>

  <!-- Attendance Table -->
  <div class="card">
    <table class="table" id="attTable">
      <thead>
        <tr>
          <th>S/N</th>
          <th>Name</th>
          <th>Phone</th>
          <th colspan="12">Weeks (1‚Äì12)</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will load dynamically -->
      </tbody>
    </table>
  </div>

  <!-- Footer -->
  <footer>
    &copy; 2025 Madarasatun Nisa'i
  </footer>

  <!-- Script -->
  <script>
    async function loadAttendance() {
      try {
        const res = await fetch('/api/students');
        const data = await res.json();
        const tbody = document.querySelector('#attTable tbody');
        tbody.innerHTML = '';

        data.forEach((s, i) => {
          const tr = document.createElement('tr');
          let weeks = '';

          for (let w = 1; w <= 12; w++) {
            const checked = s[`week${w}`] ? 'checked' : '';
            weeks += `
              <td>
                <input 
                  type="checkbox" 
                  ${checked} 
                  onchange="updateAttendance('${s.id}', 'Week${w}', this.checked)">
              </td>`;
          }

          tr.innerHTML = `
            <td>${s.sn || i + 1}</td>
            <td>${s.name}</td>
            <td>${s.phone || ''}</td>
            ${weeks}
          `;

          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error('Error loading attendance', err);
      }
    }

    async function updateAttendance(id, week, present) {
      try {
        await fetch('/api/attendance', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id, week, present })
        });
      } catch (err) {
        console.error('Error updating attendance', err);
      }
    }

    loadAttendance();
  </script>
</body>
</html>
